name: 同步OK分支

on:
  schedule:
    - cron: '0 0,8,16 * * *'
  workflow_dispatch:

concurrency:
  group: sync-ok-branch-${{ github.ref }}
  cancel-in-progress: true

env:
  UPSTREAM_REPO: lystv/fmapp
  TARGET_BRANCH: ok

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: 浅克隆同步
      run: |
        echo "开始浅克隆同步流程..."
        
        WORK_DIR="/tmp/sync_work_${{ github.run_id }}"
        mkdir -p "$WORK_DIR"
        cd "$WORK_DIR"
        
        git init
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        UPSTREAM_URL="https://github.com/${{ env.UPSTREAM_REPO }}.git"
        TARGET_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        
        echo "添加上游仓库: $UPSTREAM_URL"
        git remote add upstream "$UPSTREAM_URL"
        
        echo "正在获取上游 ${{ env.TARGET_BRANCH }} 分支..."
        if ! git fetch --depth 1 upstream "${{ env.TARGET_BRANCH }}"; then
          echo "获取上游分支失败"
          exit 1
        fi
        
        echo "正在推送到目标仓库..."
        if ! git push --force "$TARGET_URL" "upstream/${{ env.TARGET_BRANCH }}:refs/heads/${{ env.TARGET_BRANCH }}"; then
          echo "推送失败"
          exit 1
        fi
        
        COMMIT_SHA=$(git rev-parse "upstream/${{ env.TARGET_BRANCH }}")
        echo "同步完成"
        echo "同步到的提交: ${COMMIT_SHA:0:8}"
        
        cd /
        rm -rf "$WORK_DIR"

    - name: 验证同步结果
      run: |
        echo "验证同步结果..."
        
        LOCAL_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/branches/${{ env.TARGET_BRANCH }}")
        LOCAL_SHA=$(echo "$LOCAL_INFO" | jq -r '.commit.sha')
        
        UPSTREAM_INFO=$(curl -s "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/branches/${{ env.TARGET_BRANCH }}")
        UPSTREAM_SHA=$(echo "$UPSTREAM_INFO" | jq -r '.commit.sha')
        
        echo "本地提交: ${LOCAL_SHA:0:8}"
        echo "上游提交: ${UPSTREAM_SHA:0:8}"
        
        if [ "$LOCAL_SHA" = "$UPSTREAM_SHA" ]; then
          echo "同步验证成功：分支已同步到最新"
        else
          echo "同步验证失败：提交不匹配"
          exit 1
        fi
